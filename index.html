<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Raycaster</title>
  <style type="text/css">
    body {
      margin: 0;
      background: #282c34;
      overflow: hidden;
    }

    canvas {
      padding-left: 0;
      padding-right: 0;
      margin-left: auto;
      margin-right: auto;
      display: block;
    }
  </style>
</head>

<body>
  <button class="toggle">toggle</button>
  <canvas id="canvas" width="150" height="150"></canvas>
  <script src='Player.js'></script>
  <script src='map.js'></script>
  <script src='Controls.js'></script>
  <script src='sizeCanvas.js'></script>
  <script src='Ray.js'></script>

  <script>
    // init variables
    const CIRCLE = Math.PI * 2
    const gridSize = 8
    const ctx = document.getElementById("canvas").getContext("2d");
    let lastTime
    let width
    let height
    let pause = false
    let now = Date.now()
    let in3D = false
    let blockWidth
    let blockHeight
    let fov = 90
    let player
    let controls
    let rays = []
    let columnWidth

    let button = document.querySelector('.toggle')
    button.addEventListener('click', () => in3D = !in3D)

    function distance(x1, y1, x2, y2) {
      let a = x1 - x2;
      let b = y1 - y2;
      return Math.hypot(a, b)
    }

    function drawMap() {
      map.forEach((type, i) => {
        ctx.beginPath()
        let startX = (i % 8) * blockSize
        let startY = Math.floor(i / 8) * blockSize
        ctx.rect(startX, startY, blockSize, blockSize)
        ctx.closePath()
        ctx.strokeStyle = 'white'
        ctx.stroke()
        ctx.fillStyle = type === 1 ? '#beeeef' : 'black'
        ctx.fill()
      })
    }

    function drawPlayer() {
      ctx.save() // saves the original rotation
      ctx.translate(player.x, player.y) // move pointer to player position
      ctx.rotate(player.direction) // rotate canvas
      ctx.translate(-(player.x), -player.y) // move pointer back to origin

      // draw a triangle
      ctx.beginPath()
      ctx.moveTo(player.x, player.y);
      ctx.lineTo(player.x - 50, player.y + 20);
      ctx.lineTo(player.x - 50, player.y - 20);
      ctx.closePath()
      ctx.fillStyle = '#00cc00'
      ctx.fill()

      ctx.restore() // sets rotation back to where it was when we called save()
    }

    function castRays() {
      rays = []
      for (let i = (-fov / 2); i < (fov / 2); i++) {
        let rayDirection = (((player.direction + (i * Math.PI / 180)) + CIRCLE) % CIRCLE)
        let ray = new Ray(rayDirection)
        rays.push(ray)
        ray.collide()
      }
    }

    function drawRay(ray) {
      let [endX, endY] = ray.collide()
      ctx.beginPath()
      ctx.moveTo(player.x, player.y)
      ctx.lineTo(endX, endY)
      ctx.closePath()
      ctx.strokeStyle = 'red'
      ctx.stroke()
    }

    function drawColumns() {
      rays.forEach((ray, i) => {
        //let distance = (Math.abs(ray.diffX) > Math.abs(ray.diffY)) ? ray.diffX / Math.cos(ray.direction) : ray.diffY / Math.sin(ray.direction)
        let distance = ray.length
        ctx.beginPath();
        //let z = ray.length * Math.cos(ray.direction)
        let x = i * columnWidth
        //let columnHeight = (canvas.height - (ray.length))
        let columnHeight = 30000 / distance
        let y = (canvas.height / 2) - columnHeight / 2
        ctx.rect(x, y, columnWidth, columnHeight)
        //console.log(x, y, columnWidth, columnHeight)
        ctx.fillStyle = "blue"
        ctx.closePath()
        ctx.fill()
      })
    }

    function render2D() {
      ctx.clearRect(0, 0, width, height);
      drawMap()
      drawPlayer()
      rays.forEach(ray => drawRay(ray))
    }

    function render3D() {
      ctx.clearRect(0, 0, width, height);
      drawColumns()
    }

    // Main animation loop
    function animationLoop() {
      if (!lastTime) lastTime = now
      now = Date.now()
      let dt = now - lastTime
      player.update(dt)
      // only calculate rays if we've moved
      if (!(player.x === player.lastX && player.lastY === player.y && player.lastDirection === player.direction)) castRays()
      if (in3D) render3D()
      else render2D()
      lastTime = Date.now()
      window.requestAnimationFrame(animationLoop);
    }

    window.onload = () => {
      window.addEventListener("resize", sizeCanvas, false);
      sizeCanvas();
      player = new Player(blockSize + blockSize / 2, blockSize + blockSize / 2, (7 * Math.PI) / 4)
      controls = new Controls()
      // Schedule the main animation loop
      window.requestAnimationFrame(animationLoop);
    };
  </script>
</body>

</html>